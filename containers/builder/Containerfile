FROM registry.access.redhat.com/ubi9/s2i-core:9.7
# https://catalog.redhat.com/en/software/containers/ubi9/s2i-core/61fb9fa7891fad8774b86e06?architecture=arm64&image=#containerfile

USER root

ENV CENTOS_RELEASE=9.0-34 \
    NODEJS_VER=22

# install centos stream & fedora repos
RUN if [ "$TARGETARCH" = "arm64" ]; then \
        dnf install -y --setopt=tsflags=nodocs \
        https://mirror.stream.centos.org/9-stream/BaseOS/aarch64/os/Packages/centos-stream-repos-${CENTOS_RELEASE}.el9.noarch.rpm \
        https://mirror.stream.centos.org/9-stream/BaseOS/aarch64/os/Packages/centos-gpg-keys-${CENTOS_RELEASE}.el9.noarch.rpm; \
    else \
        dnf install -y --setopt=tsflags=nodocs \
        https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/centos-stream-repos-${CENTOS_RELEASE}.el9.noarch.rpm \
        https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/centos-gpg-keys-${CENTOS_RELEASE}.el9.noarch.rpm; \
    fi && \
    dnf install -y --setopt=tsflags=nodocs \
    https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm


# from s2i-base containerfile
# https://catalog.redhat.com/software/containers/ubi9/s2i-base/61fba02e153d30bcbfa96ef3#containerfile
RUN yum -y module enable nodejs:$NODEJS_VER && \
    INSTALL_PKGS="autoconf \
    automake \
    bzip2 \
    gcc-c++ \
    gd-devel \
    gdb \
    git \
    libcurl-devel \
    libpq-devel \
    libxml2-devel \
    libxslt-devel \
    lsof \
    make \
    openssl-devel \
    patch \
    procps-ng \
    npm \
    redhat-rpm-config \
    sqlite-devel \
    unzip \
    wget \
    which \
    zlib-devel" && \
    yum install -y --setopt=tsflags=nodocs $INSTALL_PKGS && \
    rpm -V $INSTALL_PKGS && \
    node -v | grep -qe "^v$NODEJS_VER\." && echo "Found VERSION $NODEJS_VER" && \
    yum -y clean all --enablerepo='*'

# install common development packages
RUN dnf install -y --setopt=tsflags=nodocs \
    python3.12 python3.12-devel python3-pip \
    git jq yq \
    nss_wrapper kmod openssh-clients nc stow \
    llvm-toolset cmake \
    clang clang-libs clang-tools-extra

# install rust
ENV CARGO_HOME=${APP_ROOT}/.cargo \
    RUSTUP_HOME=${APP_ROOT}/.rustup \
    PATH=${APP_ROOT}/.cargo/bin:${PATH}
    
RUN mkdir -p $RUSTUP_HOME $CARGO_HOME && \
    curl --proto '=https' --tlsv1.2 -sSfo rustup https://sh.rustup.rs && \
    chmod +x rustup && mv rustup /usr/bin/ && \
    rustup -y --no-modify-path --profile minimal -c rust-src -c rust-analysis -c rls

# clean up
RUN dnf -y clean all --enablerepo='*' && \
    rm -rf /var/cache/dnf

# Reset permissions of modified directories
RUN rpm-file-permissions && chown -R 1001:0 ${APP_ROOT}