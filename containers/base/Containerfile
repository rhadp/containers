FROM registry.redhat.io/devspaces/udi-rhel9:3.25.0

ARG TARGETARCH
USER root

# install centos stream & fedora repos
ENV CENTOS_RELEASE=9.0-34
RUN if [ "$TARGETARCH" = "arm64" ]; then \
        dnf install -y --setopt=tsflags=nodocs \
        https://mirror.stream.centos.org/9-stream/BaseOS/aarch64/os/Packages/centos-stream-repos-${CENTOS_RELEASE}.el9.noarch.rpm \
        https://mirror.stream.centos.org/9-stream/BaseOS/aarch64/os/Packages/centos-gpg-keys-${CENTOS_RELEASE}.el9.noarch.rpm; \
    else \
        dnf install -y --setopt=tsflags=nodocs \
        https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/centos-stream-repos-${CENTOS_RELEASE}.el9.noarch.rpm \
        https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/centos-gpg-keys-${CENTOS_RELEASE}.el9.noarch.rpm; \
    fi && \
    dnf install -y --setopt=tsflags=nodocs \
    https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm

# install basic packages
RUN dnf install -y --setopt=tsflags=nodocs \
    python3.12 python3.12-devel python3-pip \
    git jq yq \
    nss_wrapper kmod openssh-clients nc stow \
    fuse-overlayfs slirp4netns shadow-utils && \
    dnf clean all && \
    rm -rf /var/cache/dnf

# set up podman storage and config directories
RUN mkdir -p /home/user/.config/containers /home/user/.local/share/containers && \
    chown -R 10001:0 /home/user/.config /home/user/.local && \
    chmod -R g=u /home/user/.config /home/user/.local

COPY containers.conf storage.conf /home/user/.config/containers/

# alias docker to podman
RUN echo 'alias docker=podman' >> ${PROFILE_EXT}

# configure podman for nested rootless operation (no user namespaces)
ENV BUILDAH_ISOLATION=chroot \
    _CONTAINERS_USERNS_CONFIGURED=""

# python dependencies
COPY --from=ghcr.io/astral-sh/uv:latest /uv  /bin/uv
COPY --from=ghcr.io/astral-sh/uv:latest /uvx /bin/uvx

# set the virtual environment for jumpstarter etc
ENV UV_PYTHON=python3.12 VIRTUAL_ENV=/venv

# install python dependencies
COPY requirements.txt /tmp/requirements.txt
RUN uv venv /venv && \
    uv pip install -r /tmp/requirements.txt && \
    rm -rf /tmp/requirements.txt

# add init-workspace script and set up environment in a single layer
ENV PATH="/venv/bin:$PATH" \
    SCRIPTS_DIR=/home/tooling/.scripts \
    INIT_SCRIPTS_DIR=/home/tooling/.scripts/init \
    SHELL=/usr/bin/bash

RUN mkdir -p ${INIT_SCRIPTS_DIR}
COPY init-workspace ${SCRIPTS_DIR}/init-workspace

RUN echo "alias python='uv run python'" >> /home/user/.bashrc && \
    chmod +x ${SCRIPTS_DIR}/init-workspace && \
    chgrp -R 0 /home && chmod -R g=u /etc/passwd /etc/group /home /etc/pki

# Set HOME. Required for CRI-o to set /etc/passwd correctly and in general for other CLI tools
ENV HOME=/home/user

CMD ["tail", "-f", "/dev/null"]